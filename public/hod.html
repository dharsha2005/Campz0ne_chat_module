<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>HOD - Faculty & Student Management</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
    .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    h1, h2 { color: #333; }
    h2 { border-bottom: 2px solid #28a745; padding-bottom: 10px; margin-bottom: 20px; }
    .form-section { margin-bottom: 30px; padding: 20px; border: 1px solid #ddd; border-radius: 5px; background: #fafafa; }
    .form-group { margin-bottom: 15px; }
    label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
    input[type="text"], input[type="email"], input[type="password"] { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
    button { background: #28a745; color: white; padding: 12px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; margin-right: 10px; }
    button:hover { background: #218838; }
    .success { color: #28a745; background: #d4edda; padding: 10px; border-radius: 4px; margin: 10px 0; }
    .error { color: #dc3545; background: #f8d7da; padding: 10px; border-radius: 4px; margin: 10px 0; }
    .department-info { background: #e7f3ff; padding: 15px; border-radius: 5px; margin-bottom: 20px; border-left: 4px solid #007bff; }
    .faculty-list { margin-top: 20px; }
    .faculty-item { background: white; padding: 15px; margin-bottom: 10px; border-radius: 5px; border: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; }
    .role-badge { background: #28a745; color: white; padding: 3px 8px; border-radius: 12px; font-size: 12px; }
    .student-badge { background: #6c757d; color: white; padding: 3px 8px; border-radius: 12px; font-size: 12px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ðŸ‘” HOD Dashboard</h1>
    
    <div class="department-info">
      <h3>Department Information</h3>
      <p><strong>College:</strong> <span id="collegeDisplay">Loading...</span></p>
      <p><strong>Department:</strong> <span id="deptDisplay">Loading...</span></p>
      <p><strong>Your Role:</strong> Head of Department</p>
    </div>

    <div class="tabs">
      <div class="tab active" onclick="showTab('faculty')">Faculty Management</div>
      <div class="tab" onclick="showTab('students')">Student Management</div>
      <div class="tab" onclick="showTab('overview')">Overview</div>
    </div>

    <!-- Faculty Management Tab -->
    <div id="faculty-tab" class="tab-content active">
      <div class="form-section">
        <h2>Create Faculty</h2>
        <form id="facultyForm">
          <div class="form-group">
            <label for="facultyName">Faculty Name:</label>
            <input name="name" id="facultyName" placeholder="Enter faculty name" required />
          </div>
          <div class="form-group">
            <label for="facultyEmail">Email:</label>
            <input name="email" id="facultyEmail" type="email" placeholder="faculty@department.com" required />
          </div>
          <div class="form-group">
            <label for="facultyPassword">Password:</label>
            <input name="password" id="facultyPassword" type="password" placeholder="Enter password" required />
          </div>
          <div class="form-group">
            <label for="facultyDepartment">Department ID:</label>
            <input name="departmentId" id="facultyDepartment" placeholder="e.g., CSE, IT, ECE" required />
          </div>
          <div class="form-group">
            <label for="facultyClassroom">Classroom/Section:</label>
            <input name="classroomId" id="facultyClassroom" placeholder="e.g., A1, B2, C3" />
          </div>
          <button type="submit">Create Faculty</button>
        </form>
      </div>

      <div class="form-section">
        <h2>Faculty List</h2>
        <div id="facultyList" class="faculty-list">
          <p>Loading faculty list...</p>
        </div>
      </div>
    </div>

    <!-- Student Management Tab -->
    <div id="students-tab" class="tab-content">
      <div class="form-section">
        <h2>Create Student</h2>
        <form id="studentForm">
          <div class="form-group">
            <label for="studentName">Student Name:</label>
            <input name="name" id="studentName" placeholder="Enter student name" required />
          </div>
          <div class="form-group">
            <label for="studentEmail">Email:</label>
            <input name="email" id="studentEmail" type="email" placeholder="student@college.com" required />
          </div>
          <div class="form-group">
            <label for="studentPassword">Password:</label>
            <input name="password" id="studentPassword" type="password" placeholder="Enter password" required />
          </div>
          <div class="form-group">
            <label for="studentRollNumber">Roll Number:</label>
            <input name="rollNumber" id="studentRollNumber" placeholder="e.g., 23ITR030" required />
          </div>
          <div class="form-group">
            <label for="studentDepartment">Department ID:</label>
            <input name="departmentId" id="studentDepartment" placeholder="e.g., CSE, IT, ECE" required />
          </div>
          <div class="form-group">
            <label for="studentClassroom">Classroom/Section:</label>
            <input name="classroomId" id="studentClassroom" placeholder="e.g., A1, B2, C3" />
          </div>
          <button type="submit">Create Student</button>
        </form>
      </div>

      <div class="form-section">
        <h2>Student List</h2>
        <div id="studentList" class="faculty-list">
          <p>Loading student list...</p>
        </div>
      </div>
    </div>

    <!-- Overview Tab -->
    <div id="overview-tab" class="tab-content">
      <div class="form-section">
        <h2>Department Overview</h2>
        <div id="overviewStats">
          <p>Loading department statistics...</p>
        </div>
      </div>
    </div>

    <div id="message"></div>
  </div>

  <script>
    function token() { return localStorage.getItem('token'); }
    
    async function api(path, opts) {
      opts = opts || {};
      opts.headers = opts.headers || {};
      opts.headers['Authorization'] = 'Bearer ' + token();
      return fetch(path, opts).then(r => r.json());
    }

    function showMessage(message, isError = false) {
      const messageDiv = document.getElementById('message');
      messageDiv.innerHTML = `<div class="${isError ? 'error' : 'success'}">${message}</div>`;
      setTimeout(() => messageDiv.innerHTML = '', 5000);
    }

    function showTab(tabName) {
      // Hide all tabs
      document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      
      // Show selected tab
      document.getElementById(tabName + '-tab').classList.add('active');
      event.target.classList.add('active');
    }

    // Load HOD information
    async function loadHodInfo() {
      try {
        const [me, collegesRes] = await Promise.all([
          api('/api/auth/me'),
          api('/api/colleges')
        ]);
        
        if (me.success && me.data) {
          // Display department
          document.getElementById('deptDisplay').textContent = me.data.departmentId || 'Unknown';
          
          // Display college name instead of ID
          const collegeId = me.data.collegeId;
          if (collegeId) {
            if (collegesRes.success && collegesRes.data && Array.isArray(collegesRes.data)) {
              const college = collegesRes.data.find(c => String(c._id) === String(collegeId));
              if (college) {
                document.getElementById('collegeDisplay').textContent = `${college.name} (${college.code || ''})`;
              } else {
                document.getElementById('collegeDisplay').textContent = collegeId;
              }
            } else {
              document.getElementById('collegeDisplay').textContent = collegeId;
            }
          } else {
            document.getElementById('collegeDisplay').textContent = 'Not assigned';
          }
          
          // Pre-fill department in faculty form
          if (me.data.departmentId) {
            document.getElementById('facultyDepartment').value = me.data.departmentId;
          }
        } else {
          console.error('Failed to load HOD info: Invalid response', me);
          showMessage('Failed to load department information', true);
        }
      } catch (error) {
        console.error('Failed to load HOD info:', error);
        showMessage('Failed to load department information', true);
      }
    }

    // Load faculty list for the department
    async function loadFacultyList() {
      try {
        const [me, usersRes, collegesRes] = await Promise.all([
          api('/api/auth/me'),
          api('/api/users/all'),
          api('/api/colleges')
        ]);
        
        if (!me.success || !me.data) {
          throw new Error('Failed to get user info');
        }

        // Get all users and filter by department and role
        if (usersRes.success && Array.isArray(usersRes.data)) {
          const facultyUsers = usersRes.data.filter(user => 
            user.role === 'faculty' && 
            String(user.collegeId) === String(me.data.collegeId) && 
            user.departmentId === me.data.departmentId
          );
          
          const colleges = (collegesRes.success && Array.isArray(collegesRes.data)) ? collegesRes.data : [];
          
          const facultyListDiv = document.getElementById('facultyList');
          if (facultyUsers.length === 0) {
            facultyListDiv.innerHTML = '<p>No faculty found in your department.</p>';
          } else {
            facultyListDiv.innerHTML = facultyUsers.map(faculty => {
              const college = colleges.find(c => String(c._id) === String(faculty.collegeId));
              const collegeName = college ? `${college.name} (${college.code || ''})` : (faculty.collegeId || 'N/A');
              
              return `
                <div class="faculty-item">
                  <div>
                    <strong>${faculty.name || 'Unknown'}</strong><br>
                    <small>Email: ${faculty.email || 'N/A'}</small><br>
                    <small>Classroom: ${faculty.classroomId || 'Not assigned'}</small><br>
                    <small>College: ${collegeName}</small>
                  </div>
                  <span class="role-badge">FACULTY</span>
                </div>
              `;
            }).join('');
          }
        } else {
          document.getElementById('facultyList').innerHTML = '<p>Failed to load faculty list.</p>';
        }
      } catch (error) {
        console.error('Failed to load faculty list:', error);
        document.getElementById('facultyList').innerHTML = '<p>Failed to load faculty list.</p>';
      }
    }

    // Load department overview
    async function loadOverview() {
      try {
        const [me, usersRes, collegesRes] = await Promise.all([
          api('/api/auth/me'),
          api('/api/users/all'),
          api('/api/colleges')
        ]);
        
        if (!me.success || !me.data) {
          throw new Error('Failed to get user info');
        }

        // Get all users and filter by department
        if (usersRes.success && Array.isArray(usersRes.data)) {
          const deptUsers = usersRes.data.filter(user => 
            String(user.collegeId) === String(me.data.collegeId) && 
            user.departmentId === me.data.departmentId
          );
          
          const colleges = (collegesRes.success && Array.isArray(collegesRes.data)) ? collegesRes.data : [];
          const college = colleges.find(c => String(c._id) === String(me.data.collegeId));
          const collegeName = college ? `${college.name} (${college.code || ''})` : (me.data.collegeId || 'Unknown');
          
          const stats = {
            faculty: deptUsers.filter(u => u.role === 'faculty').length,
            student: deptUsers.filter(u => u.role === 'student').length
          };
          
          const container = document.getElementById('overviewStats');
          container.innerHTML = `
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px;">
              <div style="background: #d4edda; padding: 20px; border-radius: 8px; text-align: center;">
                <div style="font-size: 24px; font-weight: bold; color: #28a745;">${stats.faculty}</div>
                <div style="font-size: 12px; color: #666; text-transform: uppercase;">Faculty</div>
              </div>
              <div style="background: #e2e3e5; padding: 20px; border-radius: 8px; text-align: center;">
                <div style="font-size: 24px; font-weight: bold; color: #6c757d;">${stats.student}</div>
                <div style="font-size: 12px; color: #666; text-transform: uppercase;">Students</div>
              </div>
            </div>
            <div style="margin-top: 20px; background: #f8f9fa; padding: 15px; border-radius: 5px;">
              <h3>Department Details</h3>
              <p><strong>College:</strong> ${collegeName}</p>
              <p><strong>Department:</strong> ${me.data.departmentId || 'Unknown'}</p>
              <p><strong>Total Users:</strong> ${deptUsers.length}</p>
            </div>
          `;
        } else {
          document.getElementById('overviewStats').innerHTML = '<p>Failed to load department overview.</p>';
        }
      } catch (error) {
        console.error('Failed to load overview:', error);
        document.getElementById('overviewStats').innerHTML = '<p>Failed to load department overview.</p>';
      }
    }

    document.getElementById('facultyForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const f = e.target;
      const me = await api('/api/auth/me');
      if (!me.success || !me.data) {
        showMessage('Failed to get user information', true);
        return;
      }

      const body = {
        name: f.name.value,
        email: f.email.value,
        password: f.password.value,
        collegeId: me.data.collegeId,
        departmentId: f.departmentId.value,
        classroomId: f.classroomId.value
      };
      
      try {
        const res = await api('/api/users/faculty', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        
        if (res.success) {
          showMessage(`Faculty created successfully: ${res.data.name}`);
          f.reset();
          // Pre-fill department again
          document.getElementById('facultyDepartment').value = me.data.departmentId;
          loadFacultyList();
          loadOverview();
        } else {
          showMessage(`Error: ${res.error}`, true);
        }
      } catch (error) {
        showMessage(`Network error: ${error.message}`, true);
      }
    });

    // Student form handler
    document.getElementById('studentForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const f = e.target;
      const me = await api('/api/auth/me');
      if (!me.success || !me.data) {
        showMessage('Failed to get user information', true);
        return;
      }

      const body = {
        name: f.name.value,
        email: f.email.value,
        password: f.password.value,
        rollNumber: f.rollNumber.value,
        collegeId: me.data.collegeId,
        departmentId: f.departmentId.value,
        classroomId: f.classroomId.value
      };
      
      try {
        const res = await api('/api/users/student', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        
        if (res.success) {
          showMessage(`Student created successfully: ${res.data.name}`);
          f.reset();
          // Pre-fill department again
          document.getElementById('studentDepartment').value = me.data.departmentId;
          loadStudentList();
          loadOverview();
        } else {
          showMessage(`Error: ${res.error}`, true);
        }
      } catch (error) {
        showMessage(`Network error: ${error.message}`, true);
      }
    });

    // Load student list for the department
    async function loadStudentList() {
      try {
        const [me, usersRes, collegesRes] = await Promise.all([
          api('/api/auth/me'),
          api('/api/users/all'),
          api('/api/colleges')
        ]);
        
        if (!me.success || !me.data) {
          throw new Error('Failed to get user info');
        }

        // Get all users and filter by department and role
        if (usersRes.success && Array.isArray(usersRes.data)) {
          const studentUsers = usersRes.data.filter(user => 
            user.role === 'student' && 
            String(user.collegeId) === String(me.data.collegeId) && 
            user.departmentId === me.data.departmentId
          );
          
          const colleges = (collegesRes.success && Array.isArray(collegesRes.data)) ? collegesRes.data : [];
          
          const studentListDiv = document.getElementById('studentList');
          if (studentUsers.length === 0) {
            studentListDiv.innerHTML = '<p>No students found in your department.</p>';
          } else {
            studentListDiv.innerHTML = studentUsers.map(student => {
              const college = colleges.find(c => String(c._id) === String(student.collegeId));
              const collegeName = college ? `${college.name} (${college.code || ''})` : (student.collegeId || 'N/A');
              
              return `
                <div class="faculty-item">
                  <div>
                    <strong>${student.name || 'Unknown'}</strong><br>
                    <small>Email: ${student.email || 'N/A'}</small><br>
                    <small>Roll: ${student.rollNumber || 'N/A'}</small><br>
                    <small>Classroom: ${student.classroomId || 'Not assigned'}</small><br>
                    <small>College: ${collegeName}</small>
                  </div>
                  <span class="student-badge">STUDENT</span>
                </div>
              `;
            }).join('');
          }
        } else {
          document.getElementById('studentList').innerHTML = '<p>Failed to load student list.</p>';
        }
      } catch (error) {
        console.error('Failed to load student list:', error);
        document.getElementById('studentList').innerHTML = '<p>Failed to load student list.</p>';
      }
    }

    // Initialize the page
    loadHodInfo();
    loadFacultyList();
    loadStudentList();
    loadOverview();
  </script>
</body>
</html>